<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Luna Menu</title>
<script type="text/javascript" src="/eel.js"></script>

<style>
body {
  margin: 0;
  background: rgba(0, 0, 0, 0.92);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: 'Segoe UI', sans-serif;
}

svg {
  overflow: visible;
  filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.4));
}

.arc {
  cursor: pointer;
  transform-origin: center;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  animation: sweep 0.3s ease-out forwards;
}

.arc:hover {
  filter: brightness(1.3);
}

@keyframes sweep {
  from { transform: scale(0.7); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

.icon {
  pointer-events: none;
  fill: white;
  font-size: 28px;
  text-anchor: middle;
  dominant-baseline: middle;
}

.icon-image {
  pointer-events: none;
}

.center {
  fill: #667eea;
  cursor: pointer;
  transition: all 0.3s ease;
}

.center:hover {
  fill: #7e8ef5;
}

.breadcrumb {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 10px 20px;
  border-radius: 25px;
  font-size: 13px;
  font-weight: 600;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.tooltip {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.15);
}

.tooltip.show {
  opacity: 1;
}

.loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 16px;
  display: none;
}

.loading.show {
  display: block;
}

.hint {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(255, 255, 255, 0.5);
  font-size: 11px;
}
</style>
</head>

<body>

<div class="breadcrumb" id="breadcrumb">Menu Principal</div>
<div class="loading" id="loading">‚è≥ Carregando...</div>

<svg width="500" height="500" viewBox="-250 -250 500 500" id="menuSvg">
  <circle r="40" class="center" id="centerBtn"/>
  <text class="icon" y="5" id="centerIcon">üåô</text>
  <g id="mainGroup"></g>
  <g id="subGroup"></g>
</svg>

<div class="tooltip" id="tooltip"></div>
<div class="hint">ESC para fechar ‚Ä¢ Centro para voltar</div>

<script>
// Constantes
const R1 = 50, R2 = 120, R3 = 190;
let menuHistory = [];
let currentMenu = null;

// Estrutura do menu (agora com suporte a iconSvg)
const menuStructure = {
  id: 'root',
  label: 'Menu Principal',
  icon: 'üåô',
  items: [
    {
      id: 'conversa',
      label: 'Conversa',
      iconSvg: 'conversa.svg',  // ‚Üê Usa SVG se existir
      icon: 'üí¨',  // ‚Üê Fallback emoji
      color: '#667eea',
      items: [
        { id: 'oi', label: 'Cumprimentar', icon: 'üëã', cmd: 'Luna, oi como voc√™ est√°' },
        { id: 'como_vai', label: 'Como vai?', icon: 'üòä', cmd: 'Luna, como voc√™ est√°?' },
        { id: 'apresentar', label: 'Apresentar', icon: 'ü§ù', cmd: 'Luna, se apresente' }
      ]
    },
    {
      id: 'preco',
      label: 'Pre√ßos',
      iconSvg: 'preco.svg',
      icon: 'üí∞',
      color: '#f6d365',
      items: [
        { id: 'bitcoin', label: 'Bitcoin', icon: '‚Çø', cmd: 'Luna, qual o pre√ßo do bitcoin' },
        { id: 'ethereum', label: 'Ethereum', icon: 'Œû', cmd: 'Luna, qual o pre√ßo do ethereum' },
        { id: 'dolar', label: 'D√≥lar', icon: 'üíµ', cmd: 'Luna, qual a cota√ß√£o do d√≥lar' }
      ]
    },
    {
      id: 'visao',
      label: 'Vis√£o',
      iconSvg: 'visao.svg',
      icon: 'üëÅÔ∏è',
      color: '#a18cd1',
      items: [
        { id: 'analisar', label: 'Analisar', icon: 'üîç', cmd: 'Luna, analise a tela' },
        { id: 'ler', label: 'Ler texto', icon: 'üìñ', cmd: 'Luna, leia o texto da tela' },
        { id: 'capturar', label: 'Capturar', icon: 'üì∏', cmd: 'Luna, capture a tela' }
      ]
    },
    {
      id: 'sequencias',
      label: 'Sequencias',
      icon: 'S',
      color: '#667eea',
      items: [
        { id: 'gravar_seq', label: 'Gravar sequencia', icon: '+', cmd: 'Luna, gravar sequencia' },
        { id: 'parar_seq', label: 'Parar sequencia', icon: '‚èπ', cmd: 'Luna, parar sequencia' }
      ]
    },
    {
      id: 'web',
      label: 'Web',
      iconSvg: 'web.svg',
      icon: 'üåê',
      color: '#30cfd0',
      items: [
        { id: 'resumir', label: 'Resumir', icon: 'üìù', cmd: 'Luna, resuma essa p√°gina' },
        { id: 'traduzir', label: 'Traduzir', icon: 'üåç', cmd: 'Luna, traduza essa p√°gina' },
        { id: 'buscar', label: 'Buscar', icon: 'üîé', cmd: 'Luna, busque na web' }
      ]
    },
    {
      id: 'sistema',
      label: 'Sistema',
      iconSvg: 'sistema.svg',
      icon: 'üíª',
      color: '#48c6ef',
      items: [
        { id: 'status', label: 'Status', icon: 'üìä', cmd: 'Luna, como est√° o sistema' },
        { id: 'memoria', label: 'Mem√≥ria', icon: 'üß†', cmd: 'Luna, quanto de mem√≥ria est√° usando' },
        { id: 'processos', label: 'Processos', icon: '‚öôÔ∏è', cmd: 'Luna, mostre os processos' }
      ]
    },
    {
      id: 'game',
      label: 'Games',
      iconSvg: 'game.svg',
      icon: 'üéÆ',
      color: '#ff9a9e',
      items: [
        { id: 'dica', label: 'Dica', icon: 'üí°', cmd: 'Luna, dica para Elden Ring' },
        { id: 'guia', label: 'Guia', icon: 'üìö', cmd: 'Luna, mostre o guia do jogo' }
      ]
    },
    {
      id: 'modo',
      label: 'Modo',
      iconSvg: 'modo.svg',
      icon: 'M',
      color: '#ffecd2',
      items: [
        { id: 'assistente', label: 'Assistente', icon: 'A', cmd: 'Luna, modo assistente' },
        { id: 'vtuber', label: 'VTuber', icon: 'V', cmd: 'Luna, modo vtuber' }
      ]
    }

  ]
};

// Fun√ß√µes auxiliares
const polar = (r, a) => ({ x: r * Math.cos(a), y: r * Math.sin(a) });

function arc(r1, r2, a1, a2) {
  const p1 = polar(r2, a1), p2 = polar(r2, a2);
  const p3 = polar(r1, a2), p4 = polar(r1, a1);
  const largeArc = a2 - a1 > Math.PI ? 1 : 0;
  return `M${p1.x},${p1.y}A${r2},${r2},0,${largeArc},1,${p2.x},${p2.y}
          L${p3.x},${p3.y}A${r1},${r1},0,${largeArc},0,${p4.x},${p4.y}Z`;
}

// Renderiza √≠cone (SVG ou emoji)
function renderIcon(g, item, pos, size = 28) {
  if (item.iconSvg) {
    // Tenta carregar SVG
    const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    image.setAttribute('href', `icons/${item.iconSvg}`);
    image.setAttribute('x', pos.x - size/2);
    image.setAttribute('y', pos.y - size/2);
    image.setAttribute('width', size);
    image.setAttribute('height', size);
    image.setAttribute('class', 'icon-image');
    
    // Se SVG falhar, usa emoji
    image.onerror = () => {
      image.remove();
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', pos.x);
      text.setAttribute('y', pos.y);
      text.setAttribute('class', 'icon');
      text.setAttribute('style', `font-size: ${size}px;`);
      text.textContent = item.icon;
      g.appendChild(text);
    };
    
    g.appendChild(image);
  } else {
    // Usa emoji direto
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', pos.x);
    text.setAttribute('y', pos.y);
    text.setAttribute('class', 'icon');
    text.setAttribute('style', `font-size: ${size}px;`);
    text.textContent = item.icon;
    g.appendChild(text);
  }
}

// Renderiza menu principal
async function renderMain(menu) {
  const g = document.getElementById('mainGroup');
  g.innerHTML = '';
  
  document.getElementById('breadcrumb').textContent = menu.label;
  document.getElementById('centerIcon').textContent = menuHistory.length > 0 ? '‚Ü©Ô∏è' : menu.icon;
  
  let items = menu.items || [];
  
  // Se o menu tem item din√¢mico, carrega antes
  if (menu.id === 'root') {
    for (let item of items) {
      if (item.dynamic && item.id === 'sequencias') {
        item.items = [
          { id: 'criar_seq', label: '‚ûï Criar nova', icon: '‚ûï', cmd: 'Luna, gravar sequ√™ncia' }
        ];
        
        try {
          const loadingEl = document.getElementById('loading');
          loadingEl.classList.add('show');
          
          const sequencias = await eel.load_sequencias()();
          
          loadingEl.classList.remove('show');
          
          if (sequencias && sequencias.length > 0) {
            item.items.push(...sequencias);
          }
        } catch (e) {
          console.error('Erro ao carregar sequ√™ncias:', e);
        }
      }
    }
  }
  
  const step = 2 * Math.PI / items.length;
  
  items.forEach((item, i) => {
    const a = i * step;
    const e = a + step;
    const m = (a + e) / 2;
    
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', arc(R1, R2, a, e));
    path.setAttribute('fill', item.color || '#667eea');
    path.setAttribute('class', 'arc');
    path.style.animationDelay = `${i * 40}ms`;
    
    path.onclick = () => selectItem(item, a, e);
    path.onmouseenter = () => showTooltip(item.label);
    path.onmouseleave = () => hideTooltip();
    
    g.appendChild(path);
    
    const pos = polar((R1 + R2) / 2, m);
    renderIcon(g, item, pos, 28);
  });
}

// Renderiza submenu
function renderSub(items, startAngle, endAngle) {
  const g = document.getElementById('subGroup');
  g.innerHTML = '';
  
  if (!items || items.length === 0) return;
  
  const step = (endAngle - startAngle) / items.length;
  
  items.forEach((item, i) => {
    const a = startAngle + i * step;
    const e = a + step;
    const m = (a + e) / 2;
    
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', arc(R2 + 5, R3, a, e));
    path.setAttribute('fill', currentMenu.color || '#9b6cff');
    path.setAttribute('class', 'arc');
    path.style.animationDelay = `${i * 40}ms`;
    
    path.onclick = () => {
      if (item.cmd) {
        executeCommand(item.cmd);
      }
    };
    
    path.onmouseenter = () => showTooltip(item.label);
    path.onmouseleave = () => hideTooltip();
    
    g.appendChild(path);
    
    const pos = polar((R2 + R3) / 2 + 5, m);
    renderIcon(g, item, pos, 20);
  });
}

// Seleciona item
async function selectItem(item, startAngle, endAngle) {
  if (item.items || item.dynamic) {
    menuHistory.push(currentMenu);
    currentMenu = item;
    
    if (item.dynamic && item.id === 'sequencias') {
      const loadingEl = document.getElementById('loading');
      loadingEl.classList.add('show');
      
      try {
        const sequencias = await eel.load_sequencias()();
        item.items = [
          { id: 'criar_seq', label: '‚ûï Criar nova', icon: '‚ûï', cmd: 'Luna, gravar sequ√™ncia' }
        ];
        
        if (sequencias && sequencias.length > 0) {
          item.items.push(...sequencias);
        }
      } catch (e) {
        console.error('Erro:', e);
      }
      
      loadingEl.classList.remove('show');
    }
    
    // Op√ß√£o 1: ao entrar em um item com submenu, renderiza o menu novo
    // em c√≠rculo completo e REMOVE a "fatia" (subGroup) para n√£o duplicar.
    await renderMain(item);
    document.getElementById('subGroup').innerHTML = '';
    // renderSub(item.items, startAngle, endAngle);
  } else if (item.cmd) {
    executeCommand(item.cmd);
  }
}

// Volta ao menu anterior
function goBack() {
  if (menuHistory.length > 0) {
    document.getElementById('subGroup').innerHTML = '';
    currentMenu = menuHistory.pop();
    renderMain(currentMenu);
  } else {
    closeMenu();
  }
}

// Executa comando
async function executeCommand(cmd) {
  await eel.execute_command(cmd)();
  closeMenu();
}

// Fecha menu
function closeMenu() {
  eel.close_menu();
}

// Tooltip
function showTooltip(text) {
  const tooltip = document.getElementById('tooltip');
  tooltip.textContent = text;
  tooltip.classList.add('show');
}

function hideTooltip() {
  document.getElementById('tooltip').classList.remove('show');
}

// Centro
document.getElementById('centerBtn').onclick = goBack;

// ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    goBack();
  }
});

// Inicializa
currentMenu = menuStructure;
renderMain(currentMenu);
</script>

</body>
</html>
